post_install() {

#remove repo if existing
sed -n '1h;1!H;${g;s/###REPO for MEGA###\n.*###END REPO for MEGA###//;p;}' -i /etc/pacman.conf 

#include repo
#Add a new line if required
lastC=`tail -c1 /etc/pacman.conf || echo -n "x"`
if [ "$lastC" != "" ]; then echo >> /etc/pacman.conf; fi

cat >> /etc/pacman.conf <<-EOF
###REPO for MEGA###
[DEB_Arch_Extra]
SigLevel = Required TrustedOnly
Server = https://mega.nz/linux/MEGAsync/Arch_Extra/\$arch
###END REPO for MEGA###
EOF

#Add public key used for signing
pacman-key --add - <<KEY
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2

mI0EVj3AgQEEAO2XyJgpvE5HDRVsggcrMhf5+KpQepl7m7OyrPSgxLi72Wuy5GWp
hO64BX1UzmdUirIEOc13YxdeuhwJ3YP0wnKUyUrdWA0r2HjOz555vN6ldrPlSCBI
RxKBWRMQaR4cwNKQ8V4xV9tVdPGgrQ9L/4H3fM9fYqCwEMKBxxLZsF3PABEBAAG0
IE1lZ2FMaW1pdGVkIDxzdXBwb3J0QG1lZ2EuY28ubno+iL8EEwECACkFAlY9wIEC
GwMFCRLMAwAHCwkIBwMCAQYVCAIJCgsEFgIDAQIeAQIXgAAKCRADw606fwaOXfOS
A/998rh6f0wsrHmX2LTw2qmrWzwPj4m+vp0m3w5swPZw1x4qSNsmNsIXX8J0ZcSE
qymOwHZ0B9imBS3iz+U496NSfPNWABbIBnUAu8zq0IR28Q9pUcLe5MWFsw9NO+w2
5dByoN9JKeUftZt1x76NHn5wmxB9fv7WVlCnZJ+T16+nh7iNBFY9wIEBBADHpopM
oXNkrGZLI6Ok1F5N7+bSgiyZwkvBMAqCkPawUgwJztFKGf8F/sSbydsKRC2aQcuJ
eOj0ZPUtJ80+o3w8MsHRtZDSxDIxqqiHeupoDRI3Be9S544vI5/UmiiygTuhmNTT
NWgStoZz7hEK4IsELAG1EFodIMtBSkptDL92HwARAQABiKUEGAECAA8FAlY9wIEC
GwwFCRLMAwAACgkQA8OtOn8Gjl3HlAQAoOckF5JBJWekmlX+k2RYwtgfszk31Gq+
Jjiho4rUEW8c1EUPvK8v1jRGwjYED3ihJ6510eblYFPl+6k91OWlScnxuVVAmSn4
35RW3vR+nYUvf3s8rctbw97gJJZAA7p5oAowTux3oHotKSYhhxKcz15goMXzSb5G
/h7fJRhMnw4=
=fp/e
-----END PGP PUBLIC KEY BLOCK-----
KEY

pacman-key --lsign-key 8F208FBF12FEE766AA32AEAF03C3AD3A7F068E5D

sysctl -p /etc/sysctl.d/99-megasync-inotify-limit.conf

/bin/touch --no-create /usr/share/icons/hicolor &>/dev/null
/bin/touch --no-create /usr/share/icons/ubuntu-mono-dark &>/dev/null
/usr/bin/gtk-update-icon-cache /usr/share/icons/* &>/dev/null
}

pre_upgrade() {
killall -s SIGUSR1 megasync 2> /dev/null || true
}

post_remove() {
sed -n '1h;1!H;${g;s/###REPO for MEGA###\n.*###END REPO for MEGA###//;p;}' -i /etc/pacman.conf 

/bin/touch --no-create /usr/share/icons/hicolor &>/dev/null
/bin/touch --no-create /usr/share/icons/ubuntu-mono-dark &>/dev/null
/usr/bin/gtk-update-icon-cache /usr/share/icons/* &>/dev/null
}

post_upgrade() {
sysctl -p /etc/sysctl.d/99-megasync-inotify-limit.conf

/bin/touch --no-create /usr/share/icons/hicolor &>/dev/null
/bin/touch --no-create /usr/share/icons/ubuntu-mono-dark &>/dev/null
/usr/bin/gtk-update-icon-cache /usr/share/icons/* &>/dev/null

killall -s SIGUSR2 megasync 2> /dev/null || true
}
